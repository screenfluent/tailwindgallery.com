import { db, Websites } from 'astro:db';
import { actions } from 'astro:actions';
import AdminLayout from '../../../layouts/AdminLayout.astro';

// Get website ID from params
const { id } = Astro.params;

// Fetch website
const website = await db.select().from(Websites).where(Websites.id, '=', Number(id)).get();

if (!website) {
  return Astro.redirect('/admin/websites');
}

// Define the form action
export const updateWebsite = actions({
  async POST({ request }) {
    const formData = await request.formData();
    const url = formData.get('url') as string;
    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const showcaseType = formData.get('showcaseType') as string;
    const status = formData.get('status') as string;

    // Update the website in the database
    await db.update(Websites)
      .set({
        url,
        title,
        description,
        showcaseType,
        status,
        updatedAt: new Date()
      })
      .where(Websites.id, '=', Number(id));

    // Redirect to the websites list
    return {
      success: true,
      redirect: '/admin/websites'
    };
  }
});

<AdminLayout title={`Edit ${website.title}`}>
  <form method="POST" action={updateWebsite} class="max-w-2xl bg-white rounded-xl border border-gray-200 p-6">
    <div class="space-y-6">
      <!-- URL -->
      <div>
        <label for="url" class="block text-sm font-medium text-gray-700">Website URL</label>
        <div class="mt-1">
          <input
            type="url"
            name="url"
            id="url"
            required
            value={website.url}
            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
          />
        </div>
        <p class="mt-1 text-xs text-gray-500">Enter the full URL including https://</p>
      </div>

      <!-- Title -->
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
        <div class="mt-1">
          <input
            type="text"
            name="title"
            id="title"
            required
            value={website.title}
            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
          />
        </div>
      </div>

      <!-- Description -->
      <div>
        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
        <div class="mt-1">
          <textarea
            name="description"
            id="description"
            rows="3"
            required
            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
          >{website.description}</textarea>
        </div>
      </div>

      <!-- Showcase Type -->
      <div>
        <label for="showcaseType" class="block text-sm font-medium text-gray-700">Showcase Type</label>
        <div class="mt-1">
          <select
            name="showcaseType"
            id="showcaseType"
            required
            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
          >
            <option value="portfolio" selected={website.showcaseType === 'portfolio'}>Portfolio</option>
            <option value="saas" selected={website.showcaseType === 'saas'}>SaaS</option>
            <option value="product" selected={website.showcaseType === 'product'}>Product</option>
            <option value="media" selected={website.showcaseType === 'media'}>Media</option>
            <option value="marketplace" selected={website.showcaseType === 'marketplace'}>Marketplace</option>
            <option value="developer-tool" selected={website.showcaseType === 'developer-tool'}>Developer Tool</option>
            <option value="platform" selected={website.showcaseType === 'platform'}>Platform</option>
            <option value="other" selected={website.showcaseType === 'other'}>Other</option>
          </select>
        </div>
      </div>

      <!-- Status -->
      <div>
        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
        <div class="mt-1">
          <select
            name="status"
            id="status"
            required
            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
          >
            <option value="pending" selected={website.status === 'pending'}>Pending</option>
            <option value="approved" selected={website.status === 'approved'}>Approved</option>
            <option value="rejected" selected={website.status === 'rejected'}>Rejected</option>
          </select>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="pt-2">
        <button
          type="submit"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
        >
          Update Website
        </button>
      </div>
    </div>
  </form>
</AdminLayout> 