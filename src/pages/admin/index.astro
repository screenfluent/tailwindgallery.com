---
import { db, sql, Users, Websites, Activities } from 'astro:db';
import AdminLayout from '../../layouts/AdminLayout.astro';

// If you do want SSR for real-time data:
export const prerender = false;

// Get total number of websites
const [{ count: websitesCount }] = await db
  .select({ count: sql<number>`count(*)` })
  .from(Websites);

// Get total number of users
const [{ count: usersCount }] = await db
  .select({ count: sql<number>`count(*)` })
  .from(Users);

// Get last 5 activities
const recentActivities = await db
  .select()
  .from(Activities)
  .orderBy(Activities.createdAt, 'desc')
  .limit(5);
---

<AdminLayout title="Dashboard">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Total Websites -->
    <div class="bg-white p-6 rounded-xl border border-gray-200">
      <h3 class="text-sm font-medium text-gray-500 mb-1">Total Websites</h3>
      <p class="text-2xl font-semibold text-gray-900">{websitesCount}</p>
    </div>

    <!-- Total Users -->
    <div class="bg-white p-6 rounded-xl border border-gray-200">
      <h3 class="text-sm font-medium text-gray-500 mb-1">Total Users</h3>
      <p class="text-2xl font-semibold text-gray-900">{usersCount}</p>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white p-6 rounded-xl border border-gray-200">
      <h3 class="text-sm font-medium text-gray-500 mb-4">Quick Actions</h3>
      <div class="space-y-2">
        <a href="/admin/websites/new" class="block text-sm text-purple-600 hover:text-purple-700">
          + Add New Website
        </a>
        <a href="/admin/users/new" class="block text-sm text-purple-600 hover:text-purple-700">
          + Add New User
        </a>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="bg-white rounded-xl border border-gray-200">
    <div class="border-b border-gray-200 px-6 py-4">
      <h3 class="text-sm font-medium text-gray-500">Recent Activity</h3>
    </div>
    <div class="divide-y divide-gray-200">
      {recentActivities.map((activity) => (
        <div class="px-6 py-4">
          <p class="text-sm text-gray-900">{activity.type}</p>
          <p class="text-xs text-gray-500 mono">
            {new Date(activity.createdAt).toLocaleDateString()}
          </p>
        </div>
      ))}
    </div>
  </div>
</AdminLayout>